<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Réservations Tennis · Gestion & planification</title>

  <link rel="stylesheet" href="style.css">
  <style>
    /* Log modal overlay styling */
    #run-log-modal {
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 99890;
      display: flex; align-items: center; justify-content: center;
    }
    #run-log-bg {
      position: absolute; left:0; top:0; width:100vw; height:100vh;
      background: rgba(45,66,122,0.32);
      z-index: 99891;
    }
    #run-log-panel {
      position: relative;
      z-index: 99892;
      min-width: 320px; max-width: 700px; width: 92vw;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 5px 26px #2563eb2e;
      padding: 28px 18px 14px 18px;
      display: flex; flex-direction: column; align-items: stretch;
    }
    #run-log-header {
      font-size: 1.18em;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 14px;
      text-align: center;
    }
    #run-log-content {
      font-size: 0.99em;
      min-height: 40px;
      max-height: 38vh;
      padding: 11px 8px;
      background: #f7fafd;
      border: 1px solid #e6e8ed;
      border-radius: 8px;
      margin-bottom: 10px;
      color: #243057;
      overflow: auto;
      resize: vertical;
    }
    #run-log-close {
      max-width: 260px;
      align-self: center;
    }

    /* Form / label improvement */
    label {
      margin-top: 17px !important;
      margin-bottom: 3px;
      font-size: 1.04em;
      color: #18315a;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: block;
    }
    .condensed-fields > div {
      margin-bottom: 8px;
    }
    .main-panel fieldset,
    .main-panel .group,
    .main-panel .condensed-group,
    .main-panel .players-group {
      margin-bottom: 16px;
    }
    .main-panel input,
    .main-panel select {
      margin-top: 6px;
      margin-bottom: 4px;
      border-radius: 8px;
      font-size: 1em;
    }
    .main-panel input:focus, .main-panel select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb44;
    }
    .main-panel .players-group label {
      margin-bottom: 7px;
      margin-top: 17px;
    }
  </style>

  </style>
</head>

<body>
  <!-- Log Modal (hidden by default) -->
  <div id="run-log-modal" style="display:none;">
    <div id="run-log-bg"></div>
    <div id="run-log-panel">
      <div id="run-log-header">⏳ Running Reservation</div>
      <pre id="run-log-content"></pre>
      <button id="run-log-cancel" class="main-btn" type="button" style="margin-top:12px;margin-bottom:12px;background: #a13d5e;">Cancel</button>
    </div>
  </div>
  <div class="wrapper-app">
    <!-- Authentification panel -->
    <div class="auth-panel">
      <h2 style="color:var(--primary-dark);font-size:1.09em;text-align:center;margin-top:2px;margin-bottom:8px;">
        Identifiants globaux</h2>
      <fieldset>
        <legend>Compte tennis</legend>
        <label for="account-email">Adresse e-mail :</label>
        <input type="email" id="account-email" placeholder="Adresse e-mail" autocomplete="username" required />
        <label for="account-password">Mot de passe :</label>
        <input type="password" id="account-password" placeholder="Mot de passe" autocomplete="current-password"
          required />
      </fieldset>
      <button id="auth-save" type="button" class="main-btn" style="width:100%;margin-top:8px;margin-bottom:4px;">Enregistrer</button>
      <div id="auth-result" style="font-size:0.98em;padding-top:1px;min-height:18px;"></div>
    </div>
    <!-- Main reservation panel -->
    <div class="main-panel">
      <h1>Planification de réservations</h1>
      <form id="newResaForm" autocomplete="off">
        <div class="group condensed-group" style="margin-bottom:10px;">
          <div class="condensed-fields">
            <div>
              <label for="datepicker">Jour</label>
              <input type="date" id="datepicker" required style="width:99%;" />
            </div>
            <div>
              <label for="hour">Heure</label>
              <select id="hour" required style="width:98%;">
                <!-- Options de 08 à 22 générées dynamiquement -->
              </select>
            </div>
            <div>
              <label for="location">Lieu</label>
              <select id="location" required>
                <!-- Options will be populated dynamically -->
              </select>
            </div>
          </div>
        </div>
        <div class="group">
          <div class="condensed-fields">
            <div>
              <label for="priceType">Tarif</label>
              <select id="priceType" multiple required style="min-width: 115px;height:38px;">
                <option value="Tarif plein">Tarif plein</option>
                <option value="Tarif réduit">Tarif réduit</option>
              </select>
            </div>
            <div>
              <label for="courtType">Type de court</label>
              <select id="courtType" multiple required style="min-width: 115px;height:38px;">
                <option value="Découvert">Découvert</option>
                <option value="Couvert">Couvert</option>
              </select>
            </div>
            <div>
              <label for="plan-time">Planifier lancement à</label>
              <input type="time" id="plan-time" required value="00:00" />
            </div>
          </div>
        </div>
        <div class="players-group">
          <label>Joueurs :</label>
          <div id="players-list"></div>
          <button type="button" id="add-player" class="small-btn">+ ajouter un joueur</button>
        </div>
        <button type="submit" id="plan-button" class="main-btn">Planifier la réservation</button>
        <div id="plan-result"></div>
      </form>

      <div id="reservations-list"></div>
    </div>
  </div>

  <!-- Default form values configuration -->
  <script src="form-defaults.js"></script>
  <script>
    // État global simplifié
    const globalAuth = {
      email: "",
      password: ""
    };


    let reservations = []; // Liste synchronisée avec le backend

    // Apply FORM_DEFAULTS players if defined, else use fallback
    let playersList = (window.FORM_DEFAULTS && Array.isArray(FORM_DEFAULTS.players) && FORM_DEFAULTS.players.length)
      ? FORM_DEFAULTS.players.map(p => ({ ...p }))
      : [{ firstName: "Louis", lastName: "Gallais" }];

    function pad2(x) { return (x < 10 ? '0' : '') + x }
    function toJJMMAAAA_fromISO(dateValue) {
      // yyyy-mm-dd → dd/mm/yyyy
      if (!dateValue) return "";
      const [y, m, d] = dateValue.split("-");
      if (!y || !m || !d) return dateValue;
      return pad2(+d) + "/" + pad2(+m) + "/" + y;
    }
    function fromJJMMAAAAtoISO(fr) {
      const m = fr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) return m[3] + "-" + pad2(+m[2]) + "-" + pad2(+m[1]);
      return "";
    }

    function saveAuthToLocal() {
      globalAuth.email = document.getElementById("account-email").value;
      globalAuth.password = document.getElementById("account-password").value;
      localStorage.setItem("scrappyAuth", JSON.stringify(globalAuth));
      document.getElementById("auth-result").innerText = "Identifiants enregistrés.";
      setTimeout(() => { document.getElementById("auth-result").innerText = ""; }, 1300);
    }
    function loadAuthFromLocal() {
      try {
        const s = JSON.parse(localStorage.getItem("scrappyAuth"));
        if (s && s.email) globalAuth.email = document.getElementById("account-email").value = s.email;
        if (s && s.password) globalAuth.password = document.getElementById("account-password").value = s.password;
      } catch { }
    }

    // Partie joueurs dynamique
    function renderPlayersInputs() {
      const playersDiv = document.getElementById("players-list");
      playersDiv.innerHTML = "";
      playersList.forEach((p, idx) => {
        const line = document.createElement("div");
        line.className = "player-row";
        const inputFirst = document.createElement("input");
        inputFirst.type = "text";
        inputFirst.placeholder = "Prénom";
        inputFirst.value = p.firstName || "";
        inputFirst.required = true;
        inputFirst.style.width = "44%";
        inputFirst.oninput = () => { playersList[idx].firstName = inputFirst.value; };
        const inputLast = document.createElement("input");
        inputLast.type = "text";
        inputLast.placeholder = "Nom";
        inputLast.value = p.lastName || "";
        inputLast.required = true;
        inputLast.style.width = "44%";
        inputLast.oninput = () => { playersList[idx].lastName = inputLast.value; };
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "✖";
        btn.className = "small-btn";
        btn.onclick = () => { playersList.splice(idx, 1); renderPlayersInputs(); }
        line.appendChild(inputFirst);
        line.appendChild(inputLast);
        line.appendChild(btn);
        playersDiv.appendChild(line);
      });
    }
    document.getElementById("add-player").onclick = () => {
      playersList.push({ firstName: "", lastName: "" });
      renderPlayersInputs();
    };


    document.getElementById("auth-save").onclick = saveAuthToLocal;

// Fetch all reservations from backend and update the state and UI
async function fetchAndRenderReservations() {
  // Calls GET /api/reservations to get reservations from backend
  try {
    const resp = await fetch("/api/reservations");
    reservations = await resp.json();
    renderReservations();
  } catch (err) {
    reservations = [];
    renderReservations();
  }
}

// Render all reservations in the UI (called after any CRUD operation)
function renderReservations() {
  const cont = document.getElementById("reservations-list");
  cont.innerHTML = "<h3 style='margin:0 0 10px 0;color:#2057ce;'>Planified reservations</h3>";
  if (!reservations.length) {
    cont.innerHTML += "<div style='color:#888;margin:6px 0;'>No active reservation.</div>";
    return;
  }
  reservations.forEach((resa) => {
    cont.innerHTML += `
      <div class="reservation-row">
        <div class="reservation-info">
          <span><b>${resa.date} ${resa.hour}</b></span>
          <span style='margin-left:8px'>${resa.location || "Location?"}</span>
          <span style='margin-left:7px;'>${resa.priceType || ""} ${resa.courtType || ""}</span>
          <span style='margin-left:7px;'>${(resa.players || []).map(p => p.firstName + " " + p.lastName).join(", ")}</span>
        </div>
        <div class="reservation-status ${resa.status}">
          ${resa.status === "pending" ? "Planified for " + resa.planTime :
              resa.status === "started" ? "Started" :
                resa.status === "ok" ? "Completed" :
                  resa.status === "cancelled" ? "Cancelled" : "Failed"}
        </div>
        <div class="reservation-actions">
          <button class="small-btn" style="background:#2563eb;" onclick="startReservation('${resa.id}')">▶</button>
          <button class="small-btn" style="background:#535c7b;" onclick="removeReservation('${resa.id}')">✕</button>
        </div>
      </div>
      `;
  });
}

// Delete a reservation by id (calls backend then refreshes UI)
window.removeReservation = async function (id) {
  if (!id) return;
  await fetch(`/api/reservations/${id}`, { method: "DELETE" });
  await fetchAndRenderReservations();
};

// Start a reservation by id (calls backend with current globalAuth)
// Start a reservation by id (calls backend with current globalAuth)
window.startReservation = async function (id) {
  const r = reservations.find(x => x.id === id);
  if (!r) return;
  r.status = "started";
  renderReservations();

  const modal = document.getElementById('run-log-modal');
  const logContent = document.getElementById('run-log-content');
  const cancelButton = document.getElementById('run-log-cancel');
  let eventSource;

  function showLogModal(text) {
    logContent.textContent = text;
    modal.style.display = "flex";
  }

  function appendLog(text) {
    logContent.textContent += `\n${text}`;
    logContent.scrollTop = logContent.scrollHeight;
  }

  function hideLogModal() {
    if (eventSource) {
      eventSource.close();
    }
    modal.style.display = "none";
  }

  async function updateReservationStatus(status) {
    await fetch(`/api/reservations/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: status })
    });
    await fetchAndRenderReservations();
  }

  showLogModal("Initiating reservation process...");

  const configPayload = {
    reservationId: r.id,
    account: { email: globalAuth.email, password: globalAuth.password },
    locations: [r.location],
    date: r.date,
    hours: [r.hour],
    priceType: [r.priceType],
    courtType: [r.courtType],
    players: r.players
  };

  try {
    const runResponse = await fetch("/run-action", {
      method: "POST",
      body: JSON.stringify(configPayload),
      headers: { "Content-Type": "application/json" }
    });

    if (!runResponse.ok) {
      throw new Error(`Failed to start process: ${await runResponse.text()}`);
    }

    const { runId } = await runResponse.json();

    eventSource = new EventSource(`/api/run-stream/${runId}`);

    cancelButton.onclick = async () => {
      eventSource.close();
      await fetch(`/api/cancel-run/${runId}`, { method: "POST" });
      await updateReservationStatus("cancelled");
      hideLogModal();
    };

    // We need a separate close button now
    const closeButton = document.createElement('button');
    closeButton.id = 'run-log-close-final';
    closeButton.className = 'main-btn';
    closeButton.textContent = 'Close';
    closeButton.style.display = 'none';
    closeButton.onclick = hideLogModal;
    if (!document.getElementById('run-log-close-final')) {
        cancelButton.parentNode.appendChild(closeButton);
    }


    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);
      switch (data.type) {
        case 'log':
          appendLog(data.message);
          break;
        case 'event':
          appendLog(`[SYSTEM] ${data.message}`);
          break;
        case 'result':
          const finalStatus = data.success ? "ok" : "failed";
          appendLog(`\n--- Process Finished ---`);
          appendLog(data.success ? "✅ Reservation Succeeded" : "❌ Reservation Failed");
          updateReservationStatus(finalStatus);
          break;
        case 'end':
          appendLog('[SYSTEM] Log stream ended.');
          eventSource.close();
          cancelButton.style.display = 'none';
          closeButton.style.display = 'block';
          break;
      }
    };

    eventSource.onerror = () => {
      appendLog("[SYSTEM] Error: Connection to log stream lost.");
      updateReservationStatus("failed");
      eventSource.close();
      cancelButton.style.display = 'none';
      closeButton.style.display = 'block';
    };

  } catch (err) {
    showLogModal(`Error: ${err.message}`);
    updateReservationStatus("failed");
  }
};

// Handle form submission: create reservations in backend for each combination (calls POST /api/reservations)
document.getElementById("newResaForm").onsubmit = async function (e) {
  e.preventDefault();
  const date = document.getElementById("datepicker").value;
  const hour = document.getElementById("hour").value;
  const location = document.getElementById("location").value.trim();
  const priceTypeSel = document.getElementById("priceType");
  const courtTypeSel = document.getElementById("courtType");
  const priceType = Array.from(priceTypeSel.selectedOptions).map(o => o.value).filter(Boolean);
  const courtType = Array.from(courtTypeSel.selectedOptions).map(o => o.value).filter(Boolean);
  const planTime = document.getElementById("plan-time").value;
  const players = playersList.map(p => ({ ...p }));

  if (!date || !hour || !location || !priceType.length || !courtType.length || !players.length) {
    document.getElementById("plan-result").innerText = "Please complete all fields.";
    return;
  }
  // For each combination, create reservation via backend
  for (const pt of priceType) {
    for (const ct of courtType) {
      const resa = {
        date: toJJMMAAAA_fromISO(date),
        hour: hour,
        location,
        priceType: pt,
        courtType: ct,
        players,
        planTime,
        status: "pending"
      };
      await fetch("/api/reservations", {
        method: "POST",
        body: JSON.stringify(resa),
        headers: { "Content-Type": "application/json" }
      });
    }
  }
  await fetchAndRenderReservations();
  document.getElementById("plan-result").innerText = "Reservation(s) added.";
  setTimeout(() => { document.getElementById("plan-result").innerText = ""; }, 1100);
};

// On window load, fetch all current reservations and show UI
// On window load, fetch all current reservations and show UI
// On window load, setup form values from FORM_DEFAULTS and fetch data
window.onload = () => {
  loadAuthFromLocal();

  // Populate hour dropdown with values 08..22
  const hourSelect = document.getElementById("hour");
  hourSelect.innerHTML = "";
  for (let h = 8; h <= 22; h++) {
    const val = pad2(h);
    const opt = document.createElement("option");
    opt.value = val;
    opt.innerText = val;
    hourSelect.appendChild(opt);
  }

  // Set input defaults from FORM_DEFAULTS if present
  if (window.FORM_DEFAULTS) {
    // Populate locations dropdown
    const locationSelect = document.getElementById("location");
    if (Array.isArray(FORM_DEFAULTS.locations)) {
      locationSelect.innerHTML = ""; // Clear existing options
      FORM_DEFAULTS.locations.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc;
        opt.innerText = loc;
        locationSelect.appendChild(opt);
      });
    }

    // Date input (now uses dynamic date from form-defaults.js)
    if (FORM_DEFAULTS.date) {
        document.getElementById("datepicker").value = FORM_DEFAULTS.date;
    }

    // Hour dropdown
    if (FORM_DEFAULTS.hour && hourSelect.querySelector(`[value="${FORM_DEFAULTS.hour}"]`))
      hourSelect.value = FORM_DEFAULTS.hour;

    // Location dropdown
    if (FORM_DEFAULTS.location && locationSelect.querySelector(`[value="${FORM_DEFAULTS.location}"]`))
      locationSelect.value = FORM_DEFAULTS.location;

    // PlanTime
    if (FORM_DEFAULTS.planTime)
      document.getElementById("plan-time").value = FORM_DEFAULTS.planTime;

    // priceType (multi)
    if (Array.isArray(FORM_DEFAULTS.priceType)) {
      const sel = document.getElementById("priceType");
      Array.from(sel.options).forEach(opt =>
        opt.selected = FORM_DEFAULTS.priceType.includes(opt.value));
    }
    // courtType (multi)
    if (Array.isArray(FORM_DEFAULTS.courtType)) {
      const sel = document.getElementById("courtType");
      Array.from(sel.options).forEach(opt =>
        opt.selected = FORM_DEFAULTS.courtType.includes(opt.value));
    }
  }

  renderPlayersInputs();
  fetchAndRenderReservations();
};
</script>
</body>

</html>
